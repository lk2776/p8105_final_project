---
title: "Milk Cows and Milk Production"
output: 
  html_document:
    code_folding: hide
    always_allow_html: true
    toc: true
    toc_float: true
---
<br>

```{r setup, include=FALSE, warning=FALSE,message=FALSE}
#load packages
library(tidyverse)
library(ggridges)
library(patchwork)
library(purrr)
library(broom)
library(readxl)
library(ggplot2)
library(sf)
library(usmap)
library(kableExtra)
library(RColorBrewer)

#R figure settings
knitr::opts_chunk$set(
  fig.width = 9,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

knitr::opts_chunk$set(
  echo = TRUE,         #code is not displayed in output
  warning = FALSE,     #warnings false
  message = FALSE      #messages false
)
```

## Milk Cows 
```{r}
#read milk cows data
milk_cows = readxl::read_excel("/Users/lk/Desktop/p8105/hw_sub/p8105_final_project/data/milkcowsandprod.xlsx", 
                               sheet="Milk cows", 
                               skip=1,
                               col_names = TRUE) |>
  janitor::clean_names() |>
  #drop_na() |>
  rename(region = x1) |>
  rename(state = back_to_content_page) |>
  filter_all(any_vars(!is.na(.))) |>
  rename_with(~ gsub("^x", "", .), starts_with("x")) |>
 mutate(region = case_when(
    state %in% c("Maine", "New Hampshire", "Vermont", "Massachusetts", "Rhode Island", 
                 "Connecticut", "New York", "New Jersey", "Pennsylvania", 
                 "Delaware", "Maryland") ~ "Northeast",
    state %in% c("Michigan","Wisconsin","Minnesota") ~ "Lake States",
    state %in% c("Ohio","Indiana","Illinois","Iowa","Missouri") ~ "Corn Belt",
    state %in% c("North Dakota", "South Dakota", "Nebraska", "Kansas") ~ "Northern Plains",
    state %in% c("Virginia", "West Virginia", "North Carolina", "Kentucky", "Tennessee") ~ "Appalachia",
    state %in% c("South Carolina", "Georgia", "Florida", "Alabama") ~ "Southeast",
    state %in% c("Mississippi", "Arkansas","Louisiana") ~ "Delta States",
    state %in% c("Oklahoma","Texas") ~ "Southern Plains",
    state %in% c("Montana","Idaho","Wyoming","Colorado","New Mexico","Arizona","Utah","Nevada") ~ "Mountain Region",
    state %in% c("Washington","Oregon","California") ~ "West Coast",
    state %in% c("Alaska","Hawaii") ~ "Other States"
    #TRUE ~ "Other"  # Default case for states not in the Northeast
  )) |>
  filter(!is.na(state)) |>
  filter(region != "Other States") |>
  mutate(
    ##remove non numeric character and convert to numeric
    `2019` = gsub("[^0-9,.-]", "", `2019`) |> as.numeric(), 
    `2020` = gsub("[^0-9,.-]", "", `2020`) |> as.numeric(),
    `2021` = gsub("[^0-9,.-]", "", `2021`) |> as.numeric(),
    `2022` = gsub("[^0-9,.-]", "", `2022`) |> as.numeric(),
    `2023` = gsub("[^0-9,.-]", "", `2023`) |> as.numeric()
  ) |>
  pivot_longer(
    cols = 3:56,
    names_to = "year",
    values_to = "number_of_cows"
  )  |>
  drop_na()

```


```{r}
#table 
top_5_states <- milk_cows |>
  group_by(state) |>
  summarise(total_cows = sum(number_of_cows, na.rm = TRUE, .groups = "drop")) |>
  arrange(desc(total_cows)) |>
  rename(State = state, 
         "Total Cows" = total_cows) |>
  head(5)  

total_cows_usa <- round(sum(milk_cows$number_of_cows, na.rm = TRUE))
avg_cows_state <- round(mean(top_5_states$`Total Cows`, na.rm = TRUE))
#min_cows_state <- min(top_5_states$`Total Cows`, na.rm = TRUE)

summary_stats <- tibble(
   State = c("Total Cows in USA",  "Avg Number of Cows in USA"), #"Min Number of Cows in USA",
  `Total Cows` = c(total_cows_usa, avg_cows_state) #min_cows_state, 
) 

final_table <- bind_rows(top_5_states, summary_stats) 

#print
knitr::kable(final_table, caption = "Top 5 States and Summary Statistics for Total Cows (1970-2023)", format="html") |>
  kable_styling(full_width = TRUE, bootstrap_options = "bordered")
```

```{r}
#line plot milk cows over years by region
milk_cows |>
  group_by(region, year) |>
  summarise(total_cows = sum(number_of_cows, na.rm = TRUE), .groups = "drop") |>  
  ggplot(aes(x = year, y = total_cows, color = region, group = region)) +  
  geom_point() +  
  geom_line() +    
  #scale_color_brewer(palette = "Set3") +  
  scale_color_manual(
    values = c("Appalachia" = "pink", 
               "Delta States" = "orange", 
               "Mountain Region" = "magenta2", 
               "Corn Belt" = "chartreuse3", 
               "Northern Plains" = "salmon", 
              "Southern Plains" = "maroon", 
              "Lake States" = "mediumturquoise",
              "Northeast" = "purple1",
              "Southeast" = "burlywood2",
                "West Coast" ="red2" )) + 
  labs(
    title = "Trend of Total Cows by Region (1970-2023)",
    x = "Year",
    y = "Total Number of Cows",
    color = "Region"
  ) +
  theme_classic() + 
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  
    legend.position = "bottom"
  )
```


```{r}
#line plot for milk cows over years across states
custom_colors <- c(
  "#FF9999", "#FF6666", "#FF3333", "#FF0000", "#990000", "#660000", 
  "#99FF99", "#66CC66", "#33CC33", "#009900", "#006600", "#003300", 
  "#99CCFF", "#66CCFF", "#33CCFF", "#0099FF", "#0066FF", "#0033FF", 
  "#CCCCFF", "#9999FF", "#6666FF", "#3333FF", "#0000FF", "#000099", 
  "#FF99FF", "#FF66FF", "#FF33FF", "#FF00FF", "#9900FF", "#6600FF", 
  "#6600CC", "#660099", "#660066", "#6666CC", "#9999CC", "#99CC99", 
  "#FFCC99", "#FFCC66", "#FFCC33", "#FF9966", "#FF9966", "#FF6699", 
  "#FF3366", "#FF0033", "#FF0000", "#990033", "#660033", "#330033", 
  "#9933CC", "#6600CC", "#3300CC"
)

milk_cows |>
  group_by(state, year) |>
  summarise(total_cows = sum(number_of_cows, na.rm = TRUE), .groups = "drop") |>  
  ggplot( aes(x = year, y = total_cows, color = state, group = state)) +  
  geom_point() +  
  geom_line() +    
  scale_color_manual(values = custom_colors) +  
  #scale_colour_discrete() + #don't like it
  labs(
    title = "Trend of Total Cows by Region (1970-2023)",
    x = "Year",
    y = "Total Number of Cows",
    color = "Region"
  ) +
  theme_classic() + 
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

```{r}


milk_cows |>
  group_by(region, year) |>
  summarise(total_cows = sum(number_of_cows, na.rm = TRUE)) |>
  ungroup() |>
  #filter(region == "Northeast") |>
ggplot(aes(x = year, y = total_cows, color = region)) + #group = region #, 
  geom_point() +  # Points for each year
  geom_line() + 
  theme(axis.text.x = element_text(angle = 80, hjust= 1))+
  labs(
    title = "Trend of Number of Cows by Region (1970-2023)",
    x = "Year",
    y = "Number of Cows",
    color = "Region"
  ) +
  theme_minimal() +  # Use a minimal theme
  scale_color_brewer(palette = "Set1") +  # Color palette for regions
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels for better readability
    legend.position = "bottom"  # Position legend at the bottom
  )
```

```{r}
top_5_states <- milk_cows |>
  group_by(state,year) |>
  summarise(total_cows = sum(number_of_cows, na.rm = TRUE)) |>
  arrange(desc(total_cows)) |>
  rename(State = state, 
         "Total Cows" = total_cows) |>
  head(5)  


test = milk_cows |>
  filter(year == 2023) |>
  #group_by(state,year) |>
  arrange(desc(number_of_cows))
  summarise(total_cows = sum(number_of_cows, na.rm = TRUE)) |>
  arrange(desc(total_cows)) |>
  rename(State = state, 
         "Total Cows" = total_cows) |>
  head(5)  

test = milk_cows |>
  filter(year == 1970) |>
  #group_by(state,year) |>
  arrange(desc(number_of_cows))

#total_cows_usa <- sum(milk_cows$number_of_cows, na.rm = TRUE)
#avg_cows_state <- mean(top_5_states$`Total Cows`, na.rm = TRUE)
#min_cows_state <- min(top_5_states$`Total Cows`, na.rm = TRUE)

#summary_stats <- tibble(
#  State = c("Total Cows in USA", "Min Number of Cows in State", "Avg Number of Cows in State"),
#  `Total Cows` = c(total_cows_usa, min_cows_state, avg_cows_state)
#) 

#final_table <- bind_rows(top_5_states, summary_stats)


#print
knitr::kable(top_5_states, caption = "Top 5 States by Total Number of Cows", format="html") |>
  kable_styling(full_width = TRUE, bootstrap_options = "bordered")
```

```{r}
#map coordinates of states
us_states <- usmap::us_map()

#abbreviation for state names
data_milk_cows = milk_cows |> mutate(
  state_abbr = state.abb[match(state, state.name)]
)

#merge location data with production data
combine_milk_cows <- us_states |>
 left_join(data_milk_cows, by = c("abbr" = "state_abbr"))

ggplot(combine_milk_cows) +
  geom_sf(aes(fill = number_of_cows), color = "white", size = 0.2) +
  #scale_fill_viridis_c(name = "number_of_cows",option = "plasma") +
  scale_fill_gradientn(
    #colors = c("pink", "magenta","orange","red"),  #magenta
    colors = c("lavender","magenta","darkmagenta","purple1"),
    name = "Number of Cows"
  ) + 
  theme_minimal() +
  labs(title = "Number of Cows by State")

ggplot(combine_milk_cows) +
  geom_point(aes(x = reorder(state, number_of_cows), y = number_of_cows, color = number_of_cows), 
             alpha = 0.7) +  
  #scale_size_continuous(name = "number_of_cows", range = c(3, 7)) +
 # scale_color_viridis_c(name = "number_of_cows")  + 
  scale_color_gradientn(
    colors = c("pink", "magenta", "orange","red"),  #magenta
    name = "Number of Cows by State"
  ) +
  theme(axis.text.x = element_text(angle = 80, hjust = 1))+
  labs(title = "Number of Cows by State", 
       x = "State",
       y = "Number of Cows")

```
